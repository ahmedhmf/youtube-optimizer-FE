<mat-card class="analyze-card">
    <mat-card-header>
        <mat-card-title>ðŸŽ¬ Analyze a New Video</mat-card-title>
        <mat-card-subtitle>
            Choose your preferred method to analyze video content with AI insights.
        </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
        <!-- Tab Navigation -->
        <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onTabChange($event)">
            <!-- URL Tab -->
            <mat-tab label="ðŸ“Ž URL Link">
                <div class="tab-content">
                    <div class="upload-section">
                        <div class="url-input-container">
                            <mat-form-field appearance="fill" class="link-field">
                                <mat-label>Video Link (YouTube, Vimeo, etc.)</mat-label>
                                <input matInput placeholder="https://example.com/video" [value]="sourceUrl()"
                                    (input)="sourceUrl.set(($any($event.target)).value)" />
                                <button matSuffix mat-icon-button type="button" (click)="toggleUrlMenu()">
                                    <mat-icon [class.rotated]="urlMenuOpen()">settings</mat-icon>
                                </button>
                            </mat-form-field>
                            @if (urlMenuOpen()) {
                            <div class="url-menu-panel">
                                <!-- Configuration Section -->
                                <div class="menu-section">
                                    <h4 class="menu-title">
                                        <mat-icon>tune</mat-icon>
                                        Configuration
                                    </h4>
                                    <div class="config-controls">
                                        <!-- Language Selection -->
                                        <mat-form-field appearance="outline" class="config-field">
                                            <mat-label>Language</mat-label>
                                            <mat-select [value]="selectedLanguage()" (selectionChange)="setLanguage($event.value)">
                                                @for (language of languages; track language.code) {
                                                <mat-option [value]="language.code">
                                                    <div class="language-option">
                                                        <span class="flag-emoji">{{ language.flag }}</span>
                                                        <span class="language-name">{{ language.name }}</span>
                                                    </div>
                                                </mat-option>
                                                }
                                            </mat-select>
                                        </mat-form-field>

                                        <!-- AI Model Selection -->
                                        <mat-form-field appearance="outline" class="config-field">
                                            <mat-label>AI Model</mat-label>
                                            <mat-select [value]="selectedAiModel()" (selectionChange)="setAiModel($event.value)">
                                                @for (model of aiModels; track model.id) {
                                                <mat-option [value]="model.id">
                                                    <div class="model-option">
                                                        <span class="model-name">{{ model.name }}</span>
                                                        <span class="model-description">{{ model.description }}</span>
                                                    </div>
                                                </mat-option>
                                                }
                                            </mat-select>
                                        </mat-form-field>

                                        <!-- Tone Selection -->
                                        <mat-form-field appearance="outline" class="config-field">
                                            <mat-label>Tone</mat-label>
                                            <mat-select [value]="selectedTone()" (selectionChange)="setTone($event.value)">
                                                @for (tone of tones; track tone.id) {
                                                <mat-option [value]="tone.id">
                                                    <div class="tone-option">
                                                        <mat-icon [style.color]="tone.color">{{ tone.icon }}</mat-icon>
                                                        <span class="tone-content">
                                                            <span class="tone-name">{{ tone.name }}</span>
                                                            <span class="tone-description">{{ tone.description }}</span>
                                                        </span>
                                                    </div>
                                                </mat-option>
                                                }
                                            </mat-select>
                                        </mat-form-field>
                                    </div>
                                </div>

                                <mat-divider></mat-divider>

                                <!-- Sample URLs Section -->
                                <div class="menu-section">
                                    <h4 class="menu-title">
                                        <mat-icon>link</mat-icon>
                                        Sample URLs
                                    </h4>
                                    <div class="menu-items">
                                        <button mat-stroked-button class="menu-item" (click)="selectSampleUrl('youtube')">
                                            <mat-icon color="warn">play_circle_filled</mat-icon>
                                            <div class="item-content">
                                                <span class="item-title">YouTube Sample</span>
                                                <span class="item-description">Rick Astley - Never Gonna Give You Up</span>
                                            </div>
                                        </button>

                                        <button mat-stroked-button class="menu-item" (click)="selectSampleUrl('vimeo')">
                                            <mat-icon color="primary">videocam</mat-icon>
                                            <div class="item-content">
                                                <span class="item-title">Vimeo Sample</span>
                                                <span class="item-description">Beautiful nature documentary</span>
                                            </div>
                                        </button>

                                        <button mat-stroked-button class="menu-item" (click)="selectSampleUrl('dailymotion')">
                                            <mat-icon color="accent">movie</mat-icon>
                                            <div class="item-content">
                                                <span class="item-title">Dailymotion Sample</span>
                                                <span class="item-description">Creative video content</span>
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                <mat-divider></mat-divider>

                                <!-- Actions Section -->
                                <div class="menu-section">
                                    <h4 class="menu-title">
                                        <mat-icon>settings</mat-icon>
                                        Actions
                                    </h4>
                                    <div class="menu-actions">
                                        <button mat-button color="warn" (click)="clearUrl()">
                                            <mat-icon>clear</mat-icon>
                                            Clear URL
                                        </button>
                                        <button mat-button (click)="pasteFromClipboard()">
                                            <mat-icon>content_paste</mat-icon>
                                            Paste from Clipboard
                                        </button>
                                        <button mat-button color="primary" (click)="resetToDefaults()">
                                            <mat-icon>restore</mat-icon>
                                            Reset to Defaults
                                        </button>
                                    </div>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- File Upload Tab -->
            <mat-tab label="ðŸ“ File Upload">
                <div class="tab-content">
                    <div class="upload-section">
                        <div class="file-upload-container">
                            <!-- File Drop Zone -->
                            <div class="file-drop-zone" 
                                 [class.dragover]="isDragOver()"
                                 (dragover)="onDragOver($event)"
                                 (dragleave)="onDragLeave($event)"
                                 (drop)="onDrop($event)"
                                 (click)="fileInput.click()">
                                
                                @if (!selectedFile()) {
                                    <div class="drop-zone-content">
                                        <mat-icon class="upload-icon">cloud_upload</mat-icon>
                                        <h3>Drop your video file here</h3>
                                        <p>or click to browse</p>
                                        <p class="file-info">Supports: MP4, AVI, MOV, MKV (Max: 100MB)</p>
                                    </div>
                                } @else {
                                    <div class="selected-file-info">
                                        <mat-icon class="file-icon">video_file</mat-icon>
                                        <div class="file-details">
                                            <h4>{{ selectedFile()?.name }}</h4>
                                            <p>{{ formatFileSize(selectedFile()?.size || 0) }} â€¢ {{ getFileType(selectedFile()?.name || '') }}</p>
                                            <div class="file-actions">
                                                <button mat-stroked-button (click)="removeFile(); $event.stopPropagation()">
                                                    <mat-icon>delete</mat-icon>
                                                    Remove
                                                </button>
                                                <button mat-stroked-button (click)="fileInput.click(); $event.stopPropagation()">
                                                    <mat-icon>swap_horiz</mat-icon>
                                                    Change File
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Hidden File Input -->
                            <input #fileInput 
                                   type="file" 
                                   accept="video/*,.mp4,.avi,.mov,.mkv,.webm" 
                                   (change)="onFileSelected($event)"
                                   style="display: none;">

                            <!-- Configuration Button for File Upload -->
                            @if (selectedFile()) {
                                <div class="file-config-section">
                                    <button mat-stroked-button (click)="toggleFileConfigMenu()" class="config-toggle-btn">
                                        <mat-icon [class.rotated]="fileConfigMenuOpen()">settings</mat-icon>
                                        Configuration Options
                                    </button>
                                    
                                    @if (fileConfigMenuOpen()) {
                                        <div class="file-config-panel">
                                            <div class="config-controls">
                                                <!-- Same configuration controls as URL tab -->
                                                <mat-form-field appearance="outline" class="config-field">
                                                    <mat-label>Language</mat-label>
                                                    <mat-select [value]="selectedLanguage()" (selectionChange)="setLanguage($event.value)">
                                                        @for (language of languages; track language.code) {
                                                        <mat-option [value]="language.code">
                                                            <div class="language-option">
                                                                <span class="flag-emoji">{{ language.flag }}</span>
                                                                <span class="language-name">{{ language.name }}</span>
                                                            </div>
                                                        </mat-option>
                                                        }
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline" class="config-field">
                                                    <mat-label>AI Model</mat-label>
                                                    <mat-select [value]="selectedAiModel()" (selectionChange)="setAiModel($event.value)">
                                                        @for (model of aiModels; track model.id) {
                                                        <mat-option [value]="model.id">
                                                            <div class="model-option">
                                                                <span class="model-name">{{ model.name }}</span>
                                                                <span class="model-description">{{ model.description }}</span>
                                                            </div>
                                                        </mat-option>
                                                        }
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline" class="config-field">
                                                    <mat-label>Tone</mat-label>
                                                    <mat-select [value]="selectedTone()" (selectionChange)="setTone($event.value)">
                                                        @for (tone of tones; track tone.id) {
                                                        <mat-option [value]="tone.id">
                                                            <div class="tone-option">
                                                                <mat-icon [style.color]="tone.color">{{ tone.icon }}</mat-icon>
                                                                <span class="tone-content">
                                                                    <span class="tone-name">{{ tone.name }}</span>
                                                                    <span class="tone-description">{{ tone.description }}</span>
                                                                </span>
                                                            </div>
                                                        </mat-option>
                                                        }
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Transcript Tab -->
            <mat-tab label="ðŸ“ Transcript">
                <div class="tab-content">
                    <div class="upload-section">
                        <div class="transcript-container">
                            <!-- Transcript Header -->
                            <div class="transcript-header">
                                <div class="header-content">
                                    <mat-icon class="header-icon">description</mat-icon>
                                    <div class="header-text">
                                        <h3>Video Transcript</h3>
                                        <p>Paste or type the video transcript for AI analysis</p>
                                    </div>
                                </div>
                                <div class="transcript-actions">
                                    <button mat-stroked-button (click)="pasteTranscriptFromClipboard()">
                                        <mat-icon>content_paste</mat-icon>
                                        Paste
                                    </button>
                                    <button mat-stroked-button (click)="clearTranscript()">
                                        <mat-icon>clear</mat-icon>
                                        Clear
                                    </button>
                                    <button mat-stroked-button (click)="toggleTranscriptConfigMenu()">
                                        <mat-icon [class.rotated]="transcriptConfigMenuOpen()">settings</mat-icon>
                                        Settings
                                    </button>
                                </div>
                            </div>

                            <!-- Text Editor -->
                            <div class="transcript-editor-container">
                                <mat-form-field appearance="outline" class="transcript-field">
                                    <mat-label>Video Transcript</mat-label>
                                    <textarea 
                                        matInput 
                                        [value]="transcript()"
                                        (input)="transcript.set(($any($event.target)).value)"
                                        placeholder="Enter or paste the video transcript here...

Examples:
â€¢ YouTube auto-generated captions
â€¢ Manual transcription
â€¢ SRT subtitle content
â€¢ VTT file content

The AI will analyze the content to provide insights about the video."
                                        rows="15"
                                        class="transcript-textarea">
                                    </textarea>
                                    <mat-hint>
                                        <span class="char-count">{{ getCharacterCount() }} characters</span>
                                        @if (getWordCount() > 0) {
                                            <span class="word-count"> â€¢ {{ getWordCount() }} words</span>
                                        }
                                    </mat-hint>
                                </mat-form-field>
                            </div>

                            <!-- Configuration Panel for Transcript -->
                            @if (transcriptConfigMenuOpen()) {
                                <div class="transcript-config-panel">
                                    <div class="config-controls">
                                        <mat-form-field appearance="outline" class="config-field">
                                            <mat-label>Language</mat-label>
                                            <mat-select [value]="selectedLanguage()" (selectionChange)="setLanguage($event.value)">
                                                @for (language of languages; track language.code) {
                                                <mat-option [value]="language.code">
                                                    <div class="language-option">
                                                        <span class="flag-emoji">{{ language.flag }}</span>
                                                        <span class="language-name">{{ language.name }}</span>
                                                    </div>
                                                </mat-option>
                                                }
                                            </mat-select>
                                        </mat-form-field>

                                        <mat-form-field appearance="outline" class="config-field">
                                            <mat-label>AI Model</mat-label>
                                            <mat-select [value]="selectedAiModel()" (selectionChange)="setAiModel($event.value)">
                                                @for (model of aiModels; track model.id) {
                                                <mat-option [value]="model.id">
                                                    <div class="model-option">
                                                        <span class="model-name">{{ model.name }}</span>
                                                        <span class="model-description">{{ model.description }}</span>
                                                    </div>
                                                </mat-option>
                                                }
                                            </mat-select>
                                        </mat-form-field>

                                        <mat-form-field appearance="outline" class="config-field">
                                            <mat-label>Tone</mat-label>
                                            <mat-select [value]="selectedTone()" (selectionChange)="setTone($event.value)">
                                                @for (tone of tones; track tone.id) {
                                                <mat-option [value]="tone.id">
                                                    <div class="tone-option">
                                                        <mat-icon [style.color]="tone.color">{{ tone.icon }}</mat-icon>
                                                        <span class="tone-content">
                                                            <span class="tone-name">{{ tone.name }}</span>
                                                            <span class="tone-description">{{ tone.description }}</span>
                                                        </span>
                                                    </div>
                                                </mat-option>
                                                }
                                            </mat-select>
                                        </mat-form-field>
                                    </div>

                                    <!-- Transcript-specific options -->
                                    <mat-divider></mat-divider>
                                    <div class="transcript-specific-controls">
                                        <h4 class="config-title">
                                            <mat-icon>text_fields</mat-icon>
                                            Transcript Options
                                        </h4>
                                        
                                        <mat-checkbox 
                                            [checked]="cleanTranscript()"
                                            (change)="cleanTranscript.set($event.checked)">
                                            Clean transcript (remove timestamps, speaker labels)
                                        </mat-checkbox>

                                        <mat-checkbox 
                                            [checked]="includeSentimentAnalysis()"
                                            (change)="includeSentimentAnalysis.set($event.checked)">
                                            Include sentiment analysis
                                        </mat-checkbox>

                                        <mat-checkbox 
                                            [checked]="extractKeywords()"
                                            (change)="extractKeywords.set($event.checked)">
                                            Extract keywords and topics
                                        </mat-checkbox>
                                    </div>
                                </div>
                            }

                            <!-- Sample Transcript Section -->
                            @if (!transcript()) {
                                <div class="sample-transcripts">
                                    <h4 class="sample-title">
                                        <mat-icon>auto_stories</mat-icon>
                                        Sample Transcripts
                                    </h4>
                                    <div class="sample-items">
                                        <button mat-stroked-button class="sample-item" (click)="loadSampleTranscript('tech')">
                                            <mat-icon color="primary">computer</mat-icon>
                                            <div class="sample-content">
                                                <span class="sample-name">Tech Tutorial</span>
                                                <span class="sample-desc">Programming tutorial transcript</span>
                                            </div>
                                        </button>

                                        <button mat-stroked-button class="sample-item" (click)="loadSampleTranscript('presentation')">
                                            <mat-icon color="accent">presentation</mat-icon>
                                            <div class="sample-content">
                                                <span class="sample-name">Business Presentation</span>
                                                <span class="sample-desc">Corporate presentation transcript</span>
                                            </div>
                                        </button>

                                        <button mat-stroked-button class="sample-item" (click)="loadSampleTranscript('interview')">
                                            <mat-icon color="warn">mic</mat-icon>
                                            <div class="sample-content">
                                                <span class="sample-name">Interview</span>
                                                <span class="sample-desc">Interview or podcast transcript</span>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>

        <!-- Action Buttons (shared between tabs) -->
        <div class="actions">
            @if(this.store.status() !== 'analyzing'){
            <button type="button" color="primary" mat-raised-button
                [disabled]="!canAnalyze() || this.store.status() === 'analyzing'" (click)="analyze()">
                <mat-icon>play_arrow</mat-icon>
                <span>Analyze</span>
            </button>
            } @else{
            <button color="primary" mat-raised-button type="button"
                [disabled]="!canAnalyze() || this.store.status() === 'analyzing'" (click)="analyze()">
                <mat-spinner diameter="20" />
                <span>Analyzing...</span>
            </button>
            }

            <button color="warn" mat-button type="button" (click)="reset()">
                Reset
            </button>
        </div>

        <!-- Results (shared between tabs) -->
        @if(this.store.status() === 'done' && store.audits()){
        <div class="result">
            <h3>Analysis Result</h3>
            <pre>{{ store.newestAudit() | json }}</pre>
        </div>
        }
        @if(this.store.status() === 'error'){
        <div class="error">{{ store.message() }}</div>
        }
    </mat-card-content>
</mat-card>